<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Activity Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Configuration Modal -->
    <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
            <h2 class="text-2xl font-bold mb-4">Google Sheets Configuration</h2>
            <p class="text-gray-600 mb-6">Enter your Google Sheets credentials to connect your data</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Google Sheet ID</label>
                    <input type="text" id="sheetIdInput" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="1xYourSheetIdHere...">
                    <p class="text-xs text-gray-500 mt-1">Found in your sheet URL: docs.google.com/spreadsheets/d/<strong>SHEET_ID</strong>/edit</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Google API Key</label>
                    <input type="password" id="apiKeyInput" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="AIza...">
                    <p class="text-xs text-gray-500 mt-1">Get from Google Cloud Console > APIs & Services > Credentials</p>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="useSampleData" checked class="mr-2">
                    <label for="useSampleData" class="text-sm text-gray-700">Use sample data (for testing)</label>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeConfig()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="saveConfig()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Save & Connect
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="app">
        <!-- Loading State -->
        <div id="loadingScreen" class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="loading text-6xl mb-4">üìä</div>
                <p class="text-xl text-gray-600 mb-2">Loading Dashboard...</p>
                <p class="text-sm text-gray-500">Fetching data from Google Sheets</p>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorScreen" class="min-h-screen flex items-center justify-center hidden">
            <div class="text-center max-w-md">
                <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                <h2 class="text-2xl font-bold text-red-600 mb-2">Connection Error</h2>
                <p class="text-gray-600 mb-4" id="errorMessage">Failed to connect to Google Sheets</p>
                <div class="space-x-3">
                    <button onclick="showConfig()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        <i class="fas fa-cog mr-2"></i>Configure
                    </button>
                    <button onclick="retryConnection()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        <i class="fas fa-redo mr-2"></i>Retry
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" class="min-h-screen p-6 hidden">
            <!-- Header -->
            <div class="mb-6 fade-in">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-4xl font-bold text-gray-900 mb-2">
                            <i class="fas fa-chart-line mr-3 text-blue-600"></i>Team Activity Dashboard
                        </h1>
                        <p class="text-gray-600">Real-time visibility into team performance and daily activities</p>
                    </div>
                    <div class="text-right">
                        <button onclick="showConfig()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 mb-2">
                            <i class="fas fa-cog mr-2"></i>Settings
                        </button>
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-clock mr-1"></i>
                            Last updated: <span id="lastUpdate">-</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            <span id="dataMode" class="px-2 py-1 bg-green-100 text-green-800 rounded"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-2"></i>Date Range
                        </label>
                        <select id="dateRange" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="week">This Week</option>
                            <option value="lastWeek">Last Week</option>
                            <option value="month">This Month</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-2"></i>Team Member
                        </label>
                        <select id="memberFilter" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">All Members</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-project-diagram mr-2"></i>Project
                        </label>
                        <select id="projectFilter" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">All Projects</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tasks mr-2"></i>Status
                        </label>
                        <select id="statusFilter" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">All Status</option>
                            <option value="Completed">Completed</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Blocked">Blocked</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-gradient-to-br from-green-400 to-green-600 rounded-lg shadow-lg p-6 text-white fade-in">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium opacity-90">Tasks Completed</span>
                        <i class="fas fa-check-circle text-2xl opacity-75"></i>
                    </div>
                    <div class="text-4xl font-bold" id="tasksCompleted">0</div>
                    <div class="text-sm opacity-75 mt-2" id="tasksChange">
                        <i class="fas fa-arrow-up"></i> Real-time
                    </div>
                </div>

                <div class="bg-gradient-to-br from-blue-400 to-blue-600 rounded-lg shadow-lg p-6 text-white fade-in">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium opacity-90">Total Hours</span>
                        <i class="fas fa-clock text-2xl opacity-75"></i>
                    </div>
                    <div class="text-4xl font-bold" id="totalHours">0</div>
                    <div class="text-sm opacity-75 mt-2" id="avgHours">
                        Avg 0 hrs/person
                    </div>
                </div>

                <div class="bg-gradient-to-br from-purple-400 to-purple-600 rounded-lg shadow-lg p-6 text-white fade-in">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium opacity-90">Active Projects</span>
                        <i class="fas fa-briefcase text-2xl opacity-75"></i>
                    </div>
                    <div class="text-4xl font-bold" id="activeProjects">0</div>
                    <div class="text-sm opacity-75 mt-2">
                        <span id="activeMembers">0</span> team members
                    </div>
                </div>

                <div class="bg-gradient-to-br from-red-400 to-red-600 rounded-lg shadow-lg p-6 text-white fade-in">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium opacity-90">Blocked Items</span>
                        <i class="fas fa-exclamation-triangle text-2xl opacity-75"></i>
                    </div>
                    <div class="text-4xl font-bold" id="blockedItems">0</div>
                    <div class="text-sm opacity-75 mt-2">
                        Needs attention
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Team Performance Table -->
                <div class="lg:col-span-2 bg-white rounded-lg shadow-lg p-6 fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-users mr-3 text-blue-600"></i>
                            Team Performance
                        </h2>
                        <button onclick="exportTeamData()" class="text-sm text-blue-600 hover:text-blue-800">
                            <i class="fas fa-download mr-1"></i>Export
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b-2 border-gray-200">
                                    <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Member</th>
                                    <th class="text-center py-3 px-2 text-sm font-semibold text-gray-700">Tasks</th>
                                    <th class="text-center py-3 px-2 text-sm font-semibold text-gray-700">Hours</th>
                                    <th class="text-center py-3 px-2 text-sm font-semibold text-gray-700">Status</th>
                                    <th class="text-center py-3 px-2 text-sm font-semibold text-gray-700">Progress</th>
                                </tr>
                            </thead>
                            <tbody id="teamTable">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">
                                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                        <p>Loading team data...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Task Status Breakdown -->
                <div class="bg-white rounded-lg shadow-lg p-6 fade-in">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-chart-pie mr-3 text-purple-600"></i>
                        Task Status
                    </h2>
                    <div class="space-y-4" id="statusBreakdown"></div>
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <div class="text-center">
                            <div class="text-5xl font-bold text-gray-900 mb-2" id="completionRate">0%</div>
                            <div class="text-sm text-gray-600">Overall Completion Rate</div>
                            <div class="mt-4">
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div id="completionBar" class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Weekly Trend -->
                <div class="bg-white rounded-lg shadow-lg p-6 fade-in">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-calendar-week mr-3 text-blue-600"></i>
                        Weekly Activity Trend
                    </h2>
                    <div class="h-64 flex items-end justify-between gap-2" id="weeklyTrend"></div>
                </div>

                <!-- Project Distribution -->
                <div class="bg-white rounded-lg shadow-lg p-6 fade-in">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-project-diagram mr-3 text-purple-600"></i>
                        Project Distribution
                    </h2>
                    <div class="space-y-3" id="projectDistribution"></div>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="bg-white rounded-lg shadow-lg p-6 fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-history mr-3 text-green-600"></i>
                        Recent Activities
                    </h2>
                    <div class="text-sm text-gray-500">
                        Showing last <span id="recentCount">10</span> activities
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-200">
                                <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Time</th>
                                <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Member</th>
                                <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Project</th>
                                <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Task</th>
                                <th class="text-center py-3 px-2 text-sm font-semibold text-gray-700">Hours</th>
                                <th class="text-center py-3 px-2 text-sm font-semibold text-gray-700">Status</th>
                                <th class="text-center py-3 px-2 text-sm font-semibold text-gray-700">Priority</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivities"></tbody>
                    </table>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-8 text-center text-sm text-gray-500 pb-6">
                <p>
                    <i class="fas fa-database mr-2"></i>
                    Data source: Google Sheets ‚Ä¢ 
                    <i class="fas fa-sync-alt mr-2 ml-2"></i>
                    Auto-refresh: Every 5 minutes ‚Ä¢ 
                    <i class="fas fa-code mr-2 ml-2"></i>
                    Hosted on GitHub Pages
                </p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        let CONFIG = {
            SHEET_ID: '',
            API_KEY: '',
            USE_SAMPLE_DATA: true,
            SHEETS: {
                ACTIVITY_LOG: 'Daily_Activity_Log',
                TEAM_MEMBERS: 'Team_Members',
                PROJECTS: 'Projects'
            },
            REFRESH_INTERVAL: 300000 // 5 minutes
        };

        // Load config from localStorage
        function loadConfig() {
            const saved = localStorage.getItem('dashboardConfig');
            if (saved) {
                CONFIG = { ...CONFIG, ...JSON.parse(saved) };
            }
        }

        // Save config to localStorage
        function saveConfigToStorage() {
            localStorage.setItem('dashboardConfig', JSON.stringify({
                SHEET_ID: CONFIG.SHEET_ID,
                API_KEY: CONFIG.API_KEY,
                USE_SAMPLE_DATA: CONFIG.USE_SAMPLE_DATA
            }));
        }

        // Sample data for demo
        const SAMPLE_DATA = {
            activities: [
                { Timestamp: '2025-11-18 09:00', Team_Member: 'Alice Johnson', Date: '2025-11-18', Project_Name: 'Website Redesign', Task_Description: 'Homepage mockup design', Hours_Spent: '2.5', Task_Status: 'Completed', Priority: 'High', Category: 'Design' },
                { Timestamp: '2025-11-18 10:00', Team_Member: 'Bob Smith', Date: '2025-11-18', Project_Name: 'API Development', Task_Description: 'User authentication API', Hours_Spent: '3.0', Task_Status: 'In Progress', Priority: 'High', Category: 'Development' },
                { Timestamp: '2025-11-18 11:00', Team_Member: 'Carol Davis', Date: '2025-11-18', Project_Name: 'Mobile App', Task_Description: 'UI components library', Hours_Spent: '2.0', Task_Status: 'Completed', Priority: 'Medium', Category: 'Design' },
                { Timestamp: '2025-11-18 14:00', Team_Member: 'David Lee', Date: '2025-11-18', Project_Name: 'Database Migration', Task_Description: 'Schema design review', Hours_Spent: '1.5', Task_Status: 'Blocked', Priority: 'High', Category: 'Development' },
                { Timestamp: '2025-11-18 15:00', Team_Member: 'Emma Wilson', Date: '2025-11-18', Project_Name: 'Website Redesign', Task_Description: 'Product roadmap planning', Hours_Spent: '2.0', Task_Status: 'Completed', Priority: 'High', Category: 'Planning' },
                { Timestamp: '2025-11-17 09:00', Team_Member: 'Alice Johnson', Date: '2025-11-17', Project_Name: 'Website Redesign', Task_Description: 'Design review meeting', Hours_Spent: '1.5', Task_Status: 'Completed', Priority: 'Medium', Category: 'Meeting' },
                { Timestamp: '2025-11-17 10:00', Team_Member: 'Frank Brown', Date: '2025-11-17', Project_Name: 'API Development', Task_Description: 'REST API endpoints', Hours_Spent: '3.5', Task_Status: 'Completed', Priority: 'High', Category: 'Development' },
                { Timestamp: '2025-11-17 11:00', Team_Member: 'Grace Taylor', Date: '2025-11-17', Project_Name: 'Mobile App', Task_Description: 'App icon design', Hours_Spent: '2.5', Task_Status: 'Completed', Priority: 'Low', Category: 'Design' },
                { Timestamp: '2025-11-17 14:00', Team_Member: 'Henry Clark', Date: '2025-11-17', Project_Name: 'Website Redesign', Task_Description: 'QA testing phase 1', Hours_Spent: '2.0', Task_Status: 'In Progress', Priority: 'Medium', Category: 'Testing' },
                { Timestamp: '2025-11-16 09:00', Team_Member: 'Bob Smith', Date: '2025-11-16', Project_Name: 'API Development', Task_Description: 'Database optimization', Hours_Spent: '4.0', Task_Status: 'Completed', Priority: 'High', Category: 'Development' },
            ],
            members: [
                { Member_Name: 'Alice Johnson', Department: 'Engineering', Role: 'Frontend Developer', Email: 'alice@company.com' },
                { Member_Name: 'Bob Smith', Department: 'Engineering', Role: 'Backend Developer', Email: 'bob@company.com' },
                { Member_Name: 'Carol Davis', Department: 'Design', Role: 'UX Designer', Email: 'carol@company.com' },
                { Member_Name: 'David Lee', Department: 'Engineering', Role: 'DevOps Engineer', Email: 'david@company.com' },
                { Member_Name: 'Emma Wilson', Department: 'Product', Role: 'Product Manager', Email: 'emma@company.com' },
                { Member_Name: 'Frank Brown', Department: 'Engineering', Role: 'Full Stack Developer', Email: 'frank@company.com' },
                { Member_Name: 'Grace Taylor', Department: 'Design', Role: 'UI Designer', Email: 'grace@company.com' },
                { Member_Name: 'Henry Clark', Department: 'Engineering', Role: 'QA Engineer', Email: 'henry@company.com' }
            ],
            projects: [
                { Project_Name: 'Website Redesign', Project_Status: 'Active', Start_Date: '2025-10-01', Target_End_Date: '2025-12-31' },
                { Project_Name: 'Mobile App', Project_Status: 'Active', Start_Date: '2025-09-15', Target_End_Date: '2025-11-30' },
                { Project_Name: 'API Development', Project_Status: 'Active', Start_Date: '2025-10-15', Target_End_Date: '2026-01-15' },
                { Project_Name: 'Marketing Campaign', Project_Status: 'Active', Start_Date: '2025-11-01', Target_End_Date: '2025-12-15' },
                { Project_Name: 'Database Migration', Project_Status: 'Active', Start_Date: '2025-11-10', Target_End_Date: '2025-12-20' }
            ]
        };

        // Global state
        let allData = [];
        let teamMembers = [];
        let projects = [];
        let filteredData = [];

        // Show/hide functions
        function showLoading() {
            document.getElementById('loadingScreen').classList.remove('hidden');
            document.getElementById('errorScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        function showDashboard() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function showConfig() {
            document.getElementById('configModal').classList.remove('hidden');
            document.getElementById('sheetIdInput').value = CONFIG.SHEET_ID;
            document.getElementById('apiKeyInput').value = CONFIG.API_KEY;
            document.getElementById('useSampleData').checked = CONFIG.USE_SAMPLE_DATA;
        }

        function closeConfig() {
            document.getElementById('configModal').classList.add('hidden');
        }

        function saveConfig() {
            CONFIG.SHEET_ID = document.getElementById('sheetIdInput').value;
            CONFIG.API_KEY = document.getElementById('apiKeyInput').value;
            CONFIG.USE_SAMPLE_DATA = document.getElementById('useSampleData').checked;
            saveConfigToStorage();
            closeConfig();
            loadDashboard();
        }

        function retryConnection() {
            loadDashboard();
        }

        // Fetch from Google Sheets
        async function fetchSheetData(sheetName) {
            if (CONFIG.USE_SAMPLE_DATA) {
                return sheetName === CONFIG.SHEETS.ACTIVITY_LOG ? SAMPLE_DATA.activities :
                       sheetName === CONFIG.SHEETS.TEAM_MEMBERS ? SAMPLE_DATA.members :
                       SAMPLE_DATA.projects;
            }

            const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${sheetName}?key=${CONFIG.API_KEY}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${sheetName}: ${response.statusText}`);
                }
                const result = await response.json();
                const rows = result.values || [];
                
                if (rows.length === 0) return [];
                
                const headers = rows[0];
                return rows.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] || '';
                    });
                    return obj;
                });
            } catch (error) {
                console.error(`Error fetching ${sheetName}:`, error);
                throw error;
            }
        }

        // Filter functions
        function filterByDateRange(data, range) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            return data.filter(item => {
                const itemDate = new Date(item.Date || item.Timestamp);
                itemDate.setHours(0, 0, 0, 0);
                
                switch(range) {
                    case 'today':
                        return itemDate.getTime() === today.getTime();
                    case 'yesterday':
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        return itemDate.getTime() === yesterday.getTime();
                    case 'week':
                        const weekAgo = new Date(today);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return itemDate >= weekAgo;
                    case 'lastWeek':
                        const twoWeeksAgo = new Date(today);
                        twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
                        const lastWeekStart = new Date(today);
                        lastWeekStart.setDate(lastWeekStart.getDate() - 7);
                        return itemDate >= twoWeeksAgo && itemDate < lastWeekStart;
                    case 'month':
                        const monthAgo = new Date(today);
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        return itemDate >= monthAgo;
                    case 'all':
                        return true;
                    default:
                        return true;
                }
            });
        }

        function applyFilters() {
            const dateRange = document.getElementById('dateRange').value;
            const memberFilter = document.getElementById('memberFilter').value;
            const projectFilter = document.getElementById('projectFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filtered = filterByDateRange(allData, dateRange);
            
            if (memberFilter !== 'all') {
                filtered = filtered.filter(d => d.Team_Member === memberFilter);
            }
            
            if (projectFilter !== 'all') {
                filtered = filtered.filter(d => d.Project_Name === projectFilter);
            }
            
            if (statusFilter !== 'all') {
                filtered = filtered.filter(d => d.Task_Status === statusFilter);
            }
            
            filteredData = filtered;
            updateDashboard();
        }

        // Calculate metrics
        function calculateMetrics() {
            const completed = filteredData.filter(d => d.Task_Status === 'Completed').length;
            const inProgress = filteredData.filter(d => d.Task_Status === 'In Progress').length;
            const blocked = filteredData.filter(d => d.Task_Status === 'Blocked').length;
            const totalHours = filteredData.reduce((sum, d) => sum + (parseFloat(d.Hours_Spent) || 0), 0);
            const uniqueProjects = new Set(filteredData.map(d => d.Project_Name).filter(p => p));
            const uniqueMembers = new Set(filteredData.map(d => d.Team_Member).filter(m => m));

            return {
                tasksCompleted: completed,
                totalHours: totalHours.toFixed(1),
                activeProjects: uniqueProjects.size,
                blockedItems: blocked,
                inProgress: inProgress,
                avgHours: uniqueMembers.size > 0 ? (totalHours / uniqueMembers.size).toFixed(1) : 0,
                completionRate: completed + inProgress + blocked > 0 
                    ? Math.round((completed / (completed + inProgress + blocked)) * 100) 
                    : 0,
                activeMembers: uniqueMembers.size
            };
        }

        function calculateTeamPerformance() {
            const memberStats = {};
            
            filteredData.forEach(item => {
                const member = item.Team_Member;
                if (!member) return;
                
                if (!memberStats[member]) {
                    memberStats[member] = {
                        name: member,
                        tasks: 0,
                        hours: 0,
                        completed: 0,
                        inProgress: 0,
                        blocked: 0
                    };
                }
                
                memberStats[member].tasks++;
                memberStats[member].hours += parseFloat(item.Hours_Spent) || 0;
                
                if (item.Task_Status === 'Completed') memberStats[member].completed++;
                if (item.Task_Status === 'In Progress') memberStats[member].inProgress++;
                if (item.Task_Status === 'Blocked') memberStats[member].blocked++;
            });
            
            return Object.values(memberStats).map(member => {
                const total = member.completed + member.inProgress + member.blocked;
                const completion = total > 0 ? Math.round((member.completed / total) * 100) : 0;
                let status = 'On Track';
                if (completion >= 90) status = 'Ahead';
                if (completion < 70) status = 'Behind';
                
                return {
                    ...member,
                    hours: member.hours.toFixed(1),
                    completion,
                    status
                };
            }).sort((a, b) => b.tasks - a.tasks);
        }

        function calculateProjectDistribution() {
            const projectStats = {};
            
            filteredData.forEach(item => {
                const project = item.Project_Name;
                if (!project) return;
                projectStats[project] = (projectStats[project] || 0) + 1;
            });
            
            const total = Object.values(projectStats).reduce((a, b) => a + b, 0);
            
            return Object.entries(projectStats)
                .map(([project, tasks]) => ({
                    project,
                    tasks,
                    percentage: total > 0 ? Math.round((tasks / total) * 100) : 0
                }))
                .sort((a, b) => b.tasks - a.tasks)
                .slice(0, 5);
        }

        function calculateWeeklyTrend() {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const trend = {};
            
            filteredData.forEach(item => {
                const date = new Date(item.Date || item.Timestamp);
                const dayIndex = date.getDay();
                const dayName = days[dayIndex === 0 ? 6 : dayIndex - 1];
                trend[dayName] = (trend[dayName] || 0) + 1;
            });
            
            return days.map(day => ({
                day,
                tasks: trend[day] || 0
            }));
        }

        // Render functions
        function renderMetrics(metrics) {
            document.getElementById('tasksCompleted').textContent = metrics.tasksCompleted;
            document.getElementById('totalHours').textContent = metrics.totalHours;
            document.getElementById('activeProjects').textContent = metrics.activeProjects;
            document.getElementById('blockedItems').textContent = metrics.blockedItems;
            document.getElementById('avgHours').textContent = `Avg ${metrics.avgHours} hrs/person`;
            document.getElementById('completionRate').textContent = `${metrics.completionRate}%`;
            document.getElementById('activeMembers').textContent = metrics.activeMembers;
            document.getElementById('completionBar').style.width = `${metrics.completionRate}%`;
        }

        function renderTeamTable(teamData) {
            const tbody = document.getElementById('teamTable');
            
            if (teamData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>No data available for selected filters</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = teamData.map(member => {
                const statusClass = 
                    member.status === 'Ahead' ? 'bg-green-100 text-green-800' :
                    member.status === 'Behind' ? 'bg-red-100 text-red-800' :
                    'bg-blue-100 text-blue-800';
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                        <td class="py-3 px-2">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold mr-3">
                                    ${member.name.charAt(0)}
                                </div>
                                <span class="text-sm font-medium text-gray-900">${member.name}</span>
                            </div>
                        </td>
                        <td class="py-3 px-2 text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${member.tasks}
                            </span>
                        </td>
                        <td class="py-3 px-2 text-center">
                            <span class="text-sm text-gray-700">${member.hours}h</span>
                        </td>
                        <td class="py-3 px-2 text-center">
                            <span class="inline-block px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                                ${member.status}
                            </span>
                        </td>
                        <td class="py-3 px-2">
                            <div class="flex items-center">
                                <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-gradient-to-r from-blue-400 to-blue-600 h-2 rounded-full transition-all duration-500" 
                                         style="width: ${member.completion}%"></div>
                                </div>
                                <span class="text-xs text-gray-600 font-medium">${member.completion}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderStatusBreakdown(metrics) {
            const statuses = [
                { status: 'Completed', count: metrics.tasksCompleted, color: 'bg-green-500', icon: 'check-circle' },
                { status: 'In Progress', count: metrics.inProgress, color: 'bg-blue-500', icon: 'clock' },
                { status: 'Blocked', count: metrics.blockedItems, color: 'bg-red-500', icon: 'exclamation-triangle' }
            ];
            
            const total = metrics.tasksCompleted + metrics.inProgress + metrics.blockedItems;
            
            document.getElementById('statusBreakdown').innerHTML = statuses.map(item => `
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700 flex items-center">
                            <i class="fas fa-${item.icon} mr-2 text-gray-400"></i>
                            ${item.status}
                        </span>
                        <span class="text-sm font-bold text-gray-900">${item.count}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="${item.color} h-3 rounded-full transition-all duration-500" 
                             style="width: ${total > 0 ? (item.count / total) * 100 : 0}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderWeeklyTrend(trend) {
            const maxTasks = Math.max(...trend.map(d => d.tasks), 1);
            
            document.getElementById('weeklyTrend').innerHTML = trend.map((day, idx) => `
                <div class="flex-1 flex flex-col items-center group">
                    <div class="tooltip w-full">
                        <div class="w-full bg-gradient-to-t from-blue-500 to-blue-400 rounded-t-lg hover:from-blue-600 hover:to-blue-500 transition-all duration-300 cursor-pointer shadow-lg"
                             style="height: ${day.tasks > 0 ? (day.tasks / maxTasks) * 100 : 5}%; min-height: ${day.tasks > 0 ? '30px' : '5px'}">
                        </div>
                        <span class="tooltiptext">${day.tasks} tasks on ${day.day}</span>
                    </div>
                    <div class="mt-3 text-xs font-semibold text-gray-600">${day.day}</div>
                    <div class="text-xs text-gray-500 font-medium">${day.tasks}</div>
                </div>
            `).join('');
        }

        function renderProjectDistribution(projects) {
            if (projects.length === 0) {
                document.getElementById('projectDistribution').innerHTML = `
                    <p class="text-center text-gray-500 py-8">
                        <i class="fas fa-inbox text-3xl mb-2"></i><br>
                        No project data available
                    </p>
                `;
                return;
            }
            
            const colors = ['bg-purple-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-red-500'];
            
            document.getElementById('projectDistribution').innerHTML = projects.map((project, idx) => `
                <div class="hover:bg-gray-50 p-2 rounded transition-colors">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700 flex items-center">
                            <span class="w-3 h-3 ${colors[idx % colors.length]} rounded-full mr-2"></span>
                            ${project.project}
                        </span>
                        <span class="text-sm text-gray-600 font-semibold">${project.tasks} tasks (${project.percentage}%)</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="${colors[idx % colors.length]} h-2.5 rounded-full transition-all duration-500" 
                             style="width: ${project.percentage}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderRecentActivities() {
            const recent = filteredData
                .sort((a, b) => new Date(b.Timestamp || b.Date) - new Date(a.Timestamp || a.Date))
                .slice(0, 10);
            
            document.getElementById('recentCount').textContent = recent.length;
            
            if (recent.length === 0) {
                document.getElementById('recentActivities').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>No recent activities</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            document.getElementById('recentActivities').innerHTML = recent.map(item => {
                const statusClass = 
                    item.Task_Status === 'Completed' ? 'bg-green-100 text-green-800' :
                    item.Task_Status === 'In Progress' ? 'bg-blue-100 text-blue-800' :
                    'bg-red-100 text-red-800';
                
                const priorityClass = 
                    item.Priority === 'High' ? 'bg-red-100 text-red-800' :
                    item.Priority === 'Medium' ? 'bg-yellow-100 text-yellow-800' :
                    'bg-gray-100 text-gray-800';
                
                const time = new Date(item.Timestamp || item.Date);
                const timeStr = time.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                        <td class="py-3 px-2 text-xs text-gray-600">${timeStr}</td>
                        <td class="py-3 px-2">
                            <div class="flex items-center">
                                <div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-xs font-bold mr-2">
                                    ${item.Team_Member.charAt(0)}
                                </div>
                                <span class="text-sm text-gray-900">${item.Team_Member}</span>
                            </div>
                        </td>
                        <td class="py-3 px-2 text-sm text-gray-700">${item.Project_Name}</td>
                        <td class="py-3 px-2 text-sm text-gray-700 max-w-xs truncate">${item.Task_Description}</td>
                        <td class="py-3 px-2 text-center">
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                ${item.Hours_Spent}h
                            </span>
                        </td>
                        <td class="py-3 px-2 text-center">
                            <span class="inline-block px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                                ${item.Task_Status}
                            </span>
                        </td>
                        <td class="py-3 px-2 text-center">
                            <span class="inline-block px-2 py-1 rounded-full text-xs font-medium ${priorityClass}">
                                ${item.Priority}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function populateFilters() {
            const memberSelect = document.getElementById('memberFilter');
            const projectSelect = document.getElementById('projectFilter');
            
            // Clear existing options except "All"
            memberSelect.innerHTML = '<option value="all">All Members</option>';
            projectSelect.innerHTML = '<option value="all">All Projects</option>';
            
            // Populate team members
            teamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.Member_Name;
                option.textContent = member.Member_Name;
                memberSelect.appendChild(option);
            });
            
            // Populate projects
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.Project_Name;
                option.textContent = project.Project_Name;
                projectSelect.appendChild(option);
            });
        }

        function updateDashboard() {
            const metrics = calculateMetrics();
            const teamPerformance = calculateTeamPerformance();
            const projectDist = calculateProjectDistribution();
            const weeklyTrend = calculateWeeklyTrend();
            
            renderMetrics(metrics);
            renderTeamTable(teamPerformance);
            renderStatusBreakdown(metrics);
            renderWeeklyTrend(weeklyTrend);
            renderProjectDistribution(projectDist);
            renderRecentActivities();
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            document.getElementById('dataMode').textContent = CONFIG.USE_SAMPLE_DATA ? 'üé® Demo Mode' : 'üî¥ Live Data';
            document.getElementById('dataMode').className = CONFIG.USE_SAMPLE_DATA 
                ? 'px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs font-medium'
                : 'px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-medium';
        }

        // Export functionality
        function exportTeamData() {
            const teamData = calculateTeamPerformance();
            const csv = [
                ['Member', 'Tasks', 'Hours', 'Completed', 'In Progress', 'Blocked', 'Status', 'Completion %'],
                ...teamData.map(m => [m.name, m.tasks, m.hours, m.completed, m.inProgress, m.blocked, m.status, m.completion])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `team-performance-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Main load function
        async function loadDashboard() {
            try {
                showLoading();
                
                if (CONFIG.USE_SAMPLE_DATA) {
                    // Use sample data
                    allData = SAMPLE_DATA.activities;
                    teamMembers = SAMPLE_DATA.members;
                    projects = SAMPLE_DATA.projects;
                    filteredData = allData;
                    
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate loading
                } else {
                    // Fetch from Google Sheets
                    if (!CONFIG.SHEET_ID || !CONFIG.API_KEY) {
                        throw new Error('Please configure your Google Sheets credentials');
                    }
                    
                    [allData, teamMembers, projects] = await Promise.all([
                        fetchSheetData(CONFIG.SHEETS.ACTIVITY_LOG),
                        fetchSheetData(CONFIG.SHEETS.TEAM_MEMBERS),
                        fetchSheetData(CONFIG.SHEETS.PROJECTS)
                    ]);
                    
                    filteredData = allData;
                }
                
                populateFilters();
                applyFilters();
                showDashboard();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError(error.message);
            }
        }

        // Event listeners
        document.getElementById('dateRange').addEventListener('change', applyFilters);
        document.getElementById('memberFilter').addEventListener('change', applyFilters);
        document.getElementById('projectFilter').addEventListener('change', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);

        // Auto-refresh
        setInterval(() => {
            if (!document.getElementById('dashboard').classList.contains('hidden')) {
                loadDashboard();
            }
        }, CONFIG.REFRESH_INTERVAL);

        // Initialize
        loadConfig();
        loadDashboard();
    </script>
</body>
</html>
